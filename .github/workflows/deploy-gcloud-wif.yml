# GitHub Actions workflow: Deploy with Google Cloud using Workload Identity Federation (WIF)
# Uses repository secrets for project info and service account
on:
  push:
    branches: [ "main" ]        # รันเมื่อ push ไป main (ใช้หลัง merge)
  pull_request:
    branches: [ "main" ]        # รันเมื่อมี PR มาที่ main (สำหรับทดสอบก่อน merge)
  workflow_dispatch:            # สั่งรันด้วยตนเองจาก Actions UI

concurrency:
  group: "gcloud-deploy"
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      id-token: write    # จำเป็นสำหรับการออก OIDC token ไปยัง GCP

    env:
      GCP_PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      GCP_PROJECT_NUMBER: ${{ secrets.GCP_PROJECT_NUMBER }}
      WIF_POOL_ID: ${{ secrets.WIF_POOL_ID }}
      WIF_PROVIDER_ID: ${{ secrets.WIF_PROVIDER_ID }}
      GCP_SA_EMAIL: ${{ secrets.GCP_SA_EMAIL }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud (Workload Identity Federation)
        uses: google-github-actions/auth@v1
        with:
          workload_identity_provider: "projects/${{ env.GCP_PROJECT_NUMBER }}/locations/global/workloadIdentityPools/${{ env.WIF_POOL_ID }}/providers/${{ env.WIF_PROVIDER_ID }}"
          service_account: "${{ env.GCP_SA_EMAIL }}"

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v1
        with:
          project_id: "${{ env.GCP_PROJECT_ID }}"

      - name: Deploy example: gcloud run
        run: |
          # ตัวอย่างคำสั่งดีพลอย — แทนที่ด้วยคำสั่งจริงของคุณถ้าจำเป็น
          gcloud run deploy my-service \
            --region=us-central1 \
            --image=gcr.io/${{ env.GCP_PROJECT_ID }}/my-image:latest \
            --platform=managed
